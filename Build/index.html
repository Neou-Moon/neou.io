<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unity WebGL Player | NeouWebGL</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Suppress favicon 404 -->
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #unity-container {
            width: 100%;
            height: 100%;
            max-width: 1920px;
            max-height: 1080px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #unity-canvas {
            width: 100%;
            height: 100%;
            aspect-ratio: 16 / 9;
            object-fit: contain;
            display: block;
            background: #000;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            z-index: 10;
        }

        #fullscreen-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
            padding: 8px 16px;
            background: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
        }

        :fullscreen #unity-container,
        :-webkit-full-screen #unity-container,
        :-moz-full-screen #unity-container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            max-height: none;
        }

        :fullscreen #unity-canvas,
        :-webkit-full-screen #unity-canvas,
        :-moz-full-screen #unity-canvas {
            width: 100%;
            height: 100%;
            aspect-ratio: 16 / 9;
            object-fit: contain;
        }
    </style>
    <!-- Use Firebase modular API -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, sendPasswordResetEmail, sendEmailVerification } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, set, update, remove, onValue, onDisconnect, push, get } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAo19slRq5C4Zikfi9k8Ktit-a7heD3nVg",
            authDomain: "neouio.firebaseapp.com",
            databaseURL: "https://neouio-default-rtdb.firebaseio.com",
            projectId: "neouio",
            storageBucket: "neouio.firebasestorage.app",
            messagingSenderId: "638848046587",
            appId: "1:638848046587:web:dd9c705197925fb012e75e",
            measurementId: "G-2BQ88H3BJW"
        };

        // Initialize Firebase with error handling
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization failed:', error.message);
            if (unityInstance) {
                unityInstance.SendMessage('GameManager', 'OnFirebaseInitFailed', error.message);
            }
            throw error;
        }

        function setUserOnlineStatus(uid, isOnline) {
            set(ref(db, `users/${uid}/online`), isOnline)
                .catch(error => console.error(`Error setting online status for UID ${uid}: ${error.code} - ${error.message}`));
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const uid = user.uid;
                console.log(`User signed in: ${uid}`);
                setUserOnlineStatus(uid, true);
                onDisconnect(ref(db, `users/${uid}/online`)).set(false);
                onValue(ref(db, `users/${uid}/partyInvites`), (snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const invite = childSnapshot.val();
                        if (invite) {
                            console.log(`Party invite received for UID ${uid}: ${JSON.stringify(invite)}`);
                            if (unityInstance) {
                                unityInstance.SendMessage('FriendsManager', 'OnPartyInviteReceived', `${invite.inviterUid}|${invite.inviterUsername}|${invite.partyId}`);
                            } else {
                                console.error('Unity instance not initialized for party invite');
                            }
                            remove(childSnapshot.ref).catch(error => console.error(`Error removing party invite: ${error.message}`));
                        }
                    });
                }, { onlyOnce: false });
            } else {
                console.log('No user signed in');
            }
        });

        window.FirebaseSaveBrightMatter = function (uid, brightMatter, gameMode) {
            const field = gameMode === "MoonRan" ? "MoonRanBrightMatter" : "TeamMoonRanBrightMatter";
            console.log(`Saving ${brightMatter} bright matter for UID ${uid} in ${gameMode}`);
            update(ref(db, 'users/' + uid), {
                [field]: brightMatter
            }).then(() => {
                console.log(`Saved ${brightMatter} bright matter successfully`);
                if (unityInstance) {
                    unityInstance.SendMessage('PlayerController', 'OnBrightMatterSaved', 'Success');
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch(error => {
                console.error('Error saving bright matter: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('PlayerController', 'OnBrightMatterSaved', 'Error: ' + error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseLoadBrightMatter = function (uid, gameMode) {
            const field = gameMode === "MoonRan" ? "MoonRanBrightMatter" : "TeamMoonRanBrightMatter";
            console.log(`Loading bright matter for UID ${uid} in ${gameMode}`);
            get(ref(db, 'users/' + uid + '/' + field)).then((snapshot) => {
                const brightMatter = snapshot.val() || 0;
                console.log(`Loaded ${brightMatter} bright matter for UID ${uid} in ${gameMode}`);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnBrightMatterLoaded', brightMatter.toString());
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch((error) => {
                console.error('Error loading bright matter: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnBrightMatterLoaded', '0');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseLoadFuel = function (uid, gameMode) {
            const field = gameMode === "MoonRan" ? "MoonRanFuel" : "TeamMoonRanFuel";
            console.log(`Loading fuel for UID ${uid} in ${gameMode}`);
            get(ref(db, 'users/' + uid + '/' + field)).then((snapshot) => {
                const fuel = snapshot.val() || 0;
                console.log(`Loaded ${fuel} fuel for UID ${uid} in ${gameMode}`);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnFuelLoaded', fuel.toString());
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch((error) => {
                console.error('Error loading fuel: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnFuelLoaded', '0');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseGetBrightMatter = function (uid, gameMode) {
            const field = gameMode === "MoonRan" ? "MoonRanBrightMatter" : "TeamMoonRanBrightMatter";
            console.log(`Retrieving bright matter for UID ${uid} in ${gameMode}`);
            get(ref(db, 'users/' + uid + '/' + field)).then((snapshot) => {
                const brightMatter = snapshot.val() || 0;
                console.log(`Retrieved ${brightMatter} bright matter for UID ${uid} in ${gameMode}`);
                if (unityInstance) {
                    unityInstance.SendMessage('PlayerController', 'OnBrightMatterRetrieved', brightMatter.toString());
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch((error) => {
                console.error('Error retrieving bright matter: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('PlayerController', 'OnBrightMatterRetrieved', '0');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseSignUp = async function (username, password) {
            console.log(`[FirebaseSignUp] Attempting to process username: ${username} with password`);

            if (!username || !password) {
                console.error('[FirebaseSignUp] Invalid input: username or password is empty');
                if (unityInstance) {
                    unityInstance.SendMessage('StartScreenController', 'OnSignUpFailed', 'Username or password is required');
                }
                return;
            }

            const sanitizedUsername = username.replace(/[^a-zA-Z0-9_-]/g, '');
            if (sanitizedUsername !== username) {
                console.error('[FirebaseSignUp] Invalid characters detected', { original: username, sanitized: sanitizedUsername });
                if (unityInstance) {
                    unityInstance.SendMessage('StartScreenController', 'OnSignUpFailed', 'Invalid username characters');
                }
                return;
            }

            if (!app) {
                console.error('[FirebaseSignUp] Firebase app not initialized');
                if (unityInstance) {
                    unityInstance.SendMessage('StartScreenController', 'OnSignUpFailed', 'Firebase not initialized');
                }
                return;
            }

            const payload = { username: sanitizedUsername, password: password };
            console.log('[FirebaseSignUp] Initiating signUp with payload:', payload);

            try {
                const response = await fetch('https://us-central1-neouio.cloudfunctions.net/signUp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Sign-up failed');
                }
                console.log('[FirebaseSignUp] Sign-up successful:', data);
                if (unityInstance) {
                    unityInstance.SendMessage(
                        'StartScreenController',
                        'OnSignUpSuccess',
                        `${data.uid}|${sanitizedUsername}`
                    );
                }
            } catch (error) {
                console.error('[FirebaseSignUp] Sign-up error:', error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('StartScreenController', 'OnSignUpFailed', error.message);
                }
            }
        };

        window.FirebaseSignIn = function (username, password) {
            console.log(`Attempting signin for username: ${username}`);
            const sanitizedUsername = username.replace(/[^a-zA-Z0-9_-]/g, '');
            signInWithEmailAndPassword(auth, sanitizedUsername + "@neouio.com", password)
                .then((userCredential) => {
                    console.log('SignIn successful, UID: ' + userCredential.user.uid);
                    setUserOnlineStatus(userCredential.user.uid, true);
                    if (unityInstance) {
                        unityInstance.SendMessage('GameManager', 'OnSignInSuccess', userCredential.user.uid + '|' + sanitizedUsername);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                })
                .catch((error) => {
                    console.error('SignIn error: ', error.code, error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage('GameManager', 'OnSignInFailed', error.message);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
        };

        window.FirebaseLinkEmail = function (uid, email, callbackObjectName) {
            console.log(`Linking email for UID: ${uid}, Email: ${email}`);
            const user = auth.currentUser;
            if (user && user.uid === uid) {
                user.updateEmail(email)
                    .then(() => {
                        console.log('Email updated successfully');
                        set(ref(db, `users/${uid}/email`), email)
                            .then(() => {
                                console.log('Email saved to database');
                                if (unityInstance) {
                                    unityInstance.SendMessage(callbackObjectName, 'OnEmailLinked', 'success');
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            })
                            .catch(error => {
                                console.error('Error saving email:', error.code, error.message);
                                if (unityInstance) {
                                    unityInstance.SendMessage(callbackObjectName, 'OnEmailLinked', error.message);
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            });
                    })
                    .catch(error => {
                        console.error('Error linking email:', error.code, error.message);
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnEmailLinked', error.message);
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    });
            } else {
                console.error('No user signed in or UID mismatch: ', uid);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnEmailLinked', 'No user signed in');
                } else {
                    console.error('Unity instance not initialized');
                }
            }
        };

        window.FirebaseSendPasswordReset = function (email, callbackObjectName) {
            console.log(`Sending password reset email to: ${email}`);
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    console.log('Password reset email sent successfully');
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPasswordResetSent', 'success');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                })
                .catch(error => {
                    console.error('Error sending password reset:', error.code, error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPasswordResetSent', error.message);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
        };

        window.FirebaseSendVerificationEmail = function (callbackObjectName) {
            console.log('Sending verification email');
            const user = auth.currentUser;
            if (user) {
                sendEmailVerification(user)
                    .then(() => {
                        console.log('Verification email sent successfully');
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnEmailVerified', 'success');
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    })
                    .catch(error => {
                        console.error('Error sending verification email:', error.code, error.message);
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnEmailVerified', error.message);
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    });
            } else {
                console.error('No user signed in for email verification');
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnEmailVerified', 'No user signed in');
                } else {
                    console.error('Unity instance not initialized');
                }
            }
        };

        window.FirebaseCheckUsernameAvailability = function (username) {
            console.log(`[FirebaseCheckUsernameAvailability] Checking availability for username: ${username}`);

            if (!username) {
                console.error('[FirebaseCheckUsernameAvailability] Invalid input: username is empty');
                if (unityInstance) {
                    unityInstance.SendMessage('StartScreenController', 'OnUsernameCheckResult', 'error|Username is empty');
                }
                return;
            }

            const sanitizedUsername = username.replace(/[^a-zA-Z0-9_-]/g, '');
            if (sanitizedUsername !== username) {
                console.error('[FirebaseCheckUsernameAvailability] Invalid characters detected', { original: username, sanitized: sanitizedUsername });
                if (unityInstance) {
                    unityInstance.SendMessage('StartScreenController', 'OnUsernameCheckResult', 'invalid|Invalid characters');
                }
                return;
            }

            fetch('https://checkusernameavailability-rgfvq764xq-uc.a.run.app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: sanitizedUsername })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[FirebaseCheckUsernameAvailability] Response:', data);
                    if (data.available !== undefined) {
                        if (data.available) {
                            if (unityInstance) {
                                unityInstance.SendMessage('StartScreenController', 'OnUsernameCheckResult', 'available');
                            }
                        } else {
                            if (unityInstance) {
                                unityInstance.SendMessage('StartScreenController', 'OnUsernameCheckResult', 'taken');
                            }
                        }
                    } else {
                        throw new Error('Invalid response format');
                    }
                })
                .catch(error => {
                    console.error('[FirebaseCheckUsernameAvailability] Check failed:', error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage('StartScreenController', 'OnUsernameCheckResult', `error|${error.message || 'Unknown error'}`);
                    }
                });
        };

        window.FirebaseGetVerificationStatus = function (callbackObjectName) {
            console.log('Checking verification status');
            const user = auth.currentUser;
            if (user) {
                user.reload().then(() => {
                    console.log('Verification status: ', user.emailVerified ? 'verified' : 'unverified');
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnVerificationStatusReceived', user.emailVerified ? 'verified' : 'unverified');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                }).catch(error => {
                    console.error('Error reloading user for verification status:', error.code, error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnVerificationStatusReceived', 'error');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
            } else {
                console.error('No user signed in for verification status check');
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnVerificationStatusReceived', 'no_user');
                } else {
                    console.error('Unity instance not initialized');
                }
            }
        };

        window.FirebaseGetEmail = function (uid, callbackObjectName) {
            console.log(`Loading email for UID: ${uid}`);
            get(ref(db, `users/${uid}/email`)).then(snapshot => {
                const email = snapshot.val() || '';
                console.log(`Email loaded: ${email}`);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnEmailLoaded', email);
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch(error => {
                console.error('Error loading email:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnEmailLoaded', '');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseSignOut = function () {
            console.log('Attempting sign out');
            const user = auth.currentUser;
            if (user) {
                const uid = user.uid;
                set(ref(db, `users/${uid}/online`), false)
                    .then(() => {
                        console.log(`Set online status to false for UID ${uid}`);
                        auth.signOut()
                            .then(() => {
                                console.log(`User ${uid} signed out successfully`);
                                if (unityInstance) {
                                    unityInstance.SendMessage('GameManager', 'OnSignOutSuccess', 'success');
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            })
                            .catch(error => {
                                console.error(`SignOut error: ${error.code} - ${error.message}`);
                                if (unityInstance) {
                                    unityInstance.SendMessage('GameManager', 'OnSignOutFailed', error.message);
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            });
                    })
                    .catch(error => {
                        console.error(`Error setting online status for UID ${uid}: ${error.code} - ${error.message}`);
                        auth.signOut()
                            .then(() => {
                                console.log(`User ${uid} signed out successfully`);
                                if (unityInstance) {
                                    unityInstance.SendMessage('GameManager', 'OnSignOutSuccess', 'success');
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            })
                            .catch(error => {
                                console.error(`SignOut error: ${error.code} - ${error.message}`);
                                if (unityInstance) {
                                    unityInstance.SendMessage('GameManager', 'OnSignOutFailed', error.message);
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            });
                    });
            } else {
                console.log("No user is currently signed in");
                if (unityInstance) {
                    unityInstance.SendMessage('GameManager', 'OnSignOutFailed', 'No user signed in');
                } else {
                    console.error('Unity instance not initialized');
                }
            }
        };

        window.FirebaseSaveCrowns = function (uid, crowns, gameMode) {
            const field = gameMode === "MoonRan" ? "MoonRanCrowns" : "TeamMoonRanCrowns";
            console.log(`Saving ${crowns} crowns for UID ${uid} in ${gameMode}`);
            update(ref(db, 'users/' + uid), {
                [field]: crowns
            }).then(() => {
                console.log(`Saved ${crowns} crowns successfully`);
                if (unityInstance) {
                    unityInstance.SendMessage('PlayerController', 'OnCrownsSaved', 'Success');
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch(error => {
                console.error('Error saving crowns: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('PlayerController', 'OnCrownsSaved', 'Error: ' + error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseLoadCrowns = function (uid, gameMode) {
            const field = gameMode === "MoonRan" ? "MoonRanCrowns" : "TeamMoonRanCrowns";
            console.log(`Loading crowns for UID ${uid} in ${gameMode}`);
            get(ref(db, 'users/' + uid + '/' + field)).then((snapshot) => {
                const crowns = snapshot.val() || 0;
                console.log(`Loaded ${crowns} crowns for UID ${uid} in ${gameMode}`);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnCrownsLoaded', crowns.toString());
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch((error) => {
                console.error('Error loading crowns: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnCrownsLoaded', '0');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseLoadLeaderboard = function (gameMode, limit) {
            const field = gameMode === "MoonRan" ? "MoonRanCrowns" : "TeamMoonRanCrowns";
            console.log(`Loading leaderboard for ${gameMode}, limit: ${limit}`);
            get(ref(db, 'users').orderByChild(field).limitToLast(limit)).then((snapshot) => {
                let entries = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    const crowns = userData[field] || 0;
                    if (crowns > 0) {
                        entries.push({
                            username: userData.username || 'Unknown',
                            crowns: crowns
                        });
                    }
                });
                entries.sort((a, b) => b.crowns - a.crowns);
                const topEntries = entries.slice(0, limit);
                let data = `${gameMode}|${topEntries.map(e => `${e.username},${e.crowns}`).join(';')}`;
                console.log(`Loaded leaderboard for ${gameMode}: ${data}`);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnLeaderboardLoaded', data);
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch((error) => {
                console.error('Error loading leaderboard: ', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnLeaderboardLoaded', `${gameMode}|`);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseSendFriendRequest = function (fromUid, toUsername, callbackObjectName) {
            console.log(`Sending friend request from UID ${fromUid} to ${toUsername}`);
            get(ref(db, 'users').orderByChild('username').equalTo(toUsername)).then(snapshot => {
                if (snapshot.exists()) {
                    const toUid = Object.keys(snapshot.val())[0];
                    if (toUid === fromUid) {
                        console.error('Cannot add yourself as a friend');
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestSent', 'Cannot add yourself');
                        } else {
                            console.error('Unity instance not initialized');
                        }
                        return;
                    }
                    set(ref(db, `friends/${toUid}/requests/${fromUid}`), auth.currentUser.displayName)
                        .then(() => {
                            console.log('Friend request sent successfully');
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestSent', 'success');
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        })
                        .catch(error => {
                            console.error('Error sending friend request:', error.code, error.message);
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestSent', error.message);
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        });
                } else {
                    console.error('User not found: ' + toUsername);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestSent', 'User not found');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                }
            }).catch(error => {
                console.error('Error checking username for friend request:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestSent', error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseAcceptFriendRequest = function (uid, friendUid, callbackObjectName) {
            console.log(`Accepting friend request for UID ${uid} from ${friendUid}`);
            get(ref(db, `users/${friendUid}/username`)).then(friendSnapshot => {
                const friendUsername = friendSnapshot.val();
                get(ref(db, `users/${uid}/username`)).then(mySnapshot => {
                    const myUsername = mySnapshot.val();
                    const updates = {};
                    updates[`friends/${uid}/requests/${friendUid}`] = null;
                    updates[`friends/${uid}/accepted/${friendUid}`] = friendUsername;
                    updates[`friends/${friendUid}/accepted/${uid}`] = myUsername;
                    update(ref(db), updates)
                        .then(() => {
                            console.log('Friend request accepted successfully');
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestAccepted', 'success');
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        })
                        .catch(error => {
                            console.error('Error accepting friend request:', error.code, error.message);
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestAccepted', error.message);
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        });
                });
            }).catch(error => {
                console.error('Error fetching usernames for friend request:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestAccepted', error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseRejectFriendRequest = function (uid, friendUid, callbackObjectName) {
            console.log(`Rejecting friend request for UID ${uid} from ${friendUid}`);
            remove(ref(db, `friends/${uid}/requests/${friendUid}`))
                .then(() => {
                    console.log('Friend request rejected successfully');
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestRejected', 'success');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                })
                .catch(error => {
                    console.error('Error rejecting friend request:', error.code, error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnFriendRequestRejected', error.message);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
        };

        window.FirebaseLoadFriends = function (uid, callbackObjectName) {
            console.log(`Loading friends for UID ${uid}`);
            get(ref(db, `friends/${uid}`)).then(snapshot => {
                let friends = [];
                let requests = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.accepted) {
                        friends = Object.entries(data.accepted).map(([uid, name]) => `${name}:${uid}`);
                    }
                    if (data.requests) {
                        requests = Object.values(data.requests).filter(r => r);
                    }
                }
                console.log(`Friends loaded: ${friends.join(',')}|${requests.join(',')}`);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnFriendsLoaded', `${friends.join(',')}|${requests.join(',')}`);
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch(error => {
                console.error('Error loading friends:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnFriendsLoaded', '');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseCreateParty = function (uid, partyId, callbackObjectName) {
            console.log(`Creating party for UID ${uid}, Party ID: ${partyId}`);
            get(ref(db, `users/${uid}/username`)).then(snapshot => {
                const username = snapshot.val();
                const updates = {};
                updates[`parties/${partyId}/members/${uid}`] = { username: username, isOnline: true };
                updates[`parties/${partyId}/leader`] = uid;
                update(ref(db), updates)
                    .then(() => {
                        console.log('Party created successfully');
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnPartyCreated', 'success');
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    })
                    .catch(error => {
                        console.error('Error creating party:', error.code, error.message);
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnPartyCreated', error.message);
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    });
            }).catch(error => {
                console.error('Error fetching username for party creation:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnPartyCreated', error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseCheckOnlineStatus = function (friendUid, callbackObjectName) {
            console.log(`Checking online status for UID ${friendUid}`);
            get(ref(db, `users/${friendUid}/online`)).then(snapshot => {
                const isOnline = snapshot.val() || false;
                console.log(`Online status for UID ${friendUid}: ${isOnline}`);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnOnlineStatusReceived', `${friendUid}|${isOnline}`);
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch(error => {
                console.error(`Error checking online status for UID ${friendUid}: ${error.code} - ${error.message}`);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnOnlineStatusReceived', `${friendUid}|false`);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseInviteToParty = function (partyId, friendUid, callbackObjectName) {
            console.log(`Inviting UID ${friendUid} to party ${partyId}`);
            get(ref(db, `users/${friendUid}/online`)).then(snapshot => {
                const isOnline = snapshot.val() || false;
                if (!isOnline) {
                    console.error('Friend is not online');
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPartyInvited', 'Friend is not online');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                    return;
                }
                get(ref(db, `users/${friendUid}/username`)).then(friendSnapshot => {
                    const friendUsername = friendSnapshot.val();
                    get(ref(db, `users/${auth.currentUser.uid}/username`)).then(inviterSnapshot => {
                        const inviterUsername = inviterSnapshot.val();
                        const inviterUid = auth.currentUser.uid;
                        const inviteKey = push(ref(db, `users/${friendUid}/partyInvites`)).key;
                        const updates = {};
                        updates[`users/${friendUid}/partyInvites/${inviteKey}`] = {
                            inviterUid: inviterUid,
                            inviterUsername: inviterUsername,
                            partyId: partyId
                        };
                        update(ref(db), updates)
                            .then(() => {
                                console.log('Party invite sent successfully');
                                if (unityInstance) {
                                    unityInstance.SendMessage(callbackObjectName, 'OnPartyInvited', 'success');
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            })
                            .catch(error => {
                                console.error('Error inviting to party:', error.code, error.message);
                                if (unityInstance) {
                                    unityInstance.SendMessage(callbackObjectName, 'OnPartyInvited', error.message);
                                } else {
                                    console.error('Unity instance not initialized');
                                }
                            });
                    });
                }).catch(error => {
                    console.error('Error fetching usernames for party invite:', error.code, error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPartyInvited', error.message);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
            }).catch(error => {
                console.error('Error checking online status for party invite:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnPartyInvited', error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseJoinParty = function (uid, partyId, callbackObjectName) {
            console.log(`UID ${uid} attempting to join party ${partyId}`);
            get(ref(db, `users/${uid}/username`)).then(snapshot => {
                const username = snapshot.val();
                get(ref(db, `parties/${partyId}/members`)).then(membersSnapshot => {
                    const memberCount = membersSnapshot.numChildren() || 0;
                    if (memberCount >= 5) {
                        console.error('Party is full');
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnPartyJoined', 'Party is full');
                        } else {
                            console.error('Unity instance not initialized');
                        }
                        return;
                    }
                    const updates = {};
                    updates[`parties/${partyId}/members/${uid}`] = { username: username, isOnline: true };
                    update(ref(db), updates)
                        .then(() => {
                            console.log('Successfully joined party');
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnPartyJoined', 'success');
                                get(ref(db, `parties/${partyId}/leader`)).then(leaderSnapshot => {
                                    const leaderUid = leaderSnapshot.val();
                                    if (leaderUid) {
                                        unityInstance.SendMessage('FriendsManager', 'OnPartyMembersLoaded', partyId);
                                    }
                                });
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        })
                        .catch(error => {
                            console.error('Error joining party:', error.code, error.message);
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnPartyJoined', error.message);
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        });
                }).catch(error => {
                    console.error('Error checking party members:', error.code, error.message);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPartyJoined', error.message);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
            }).catch(error => {
                console.error('Error fetching username for party join:', error.code, error.message);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnPartyJoined', error.message);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseLeaveParty = function (uid, partyId, callbackObjectName) {
            console.log(`UID ${uid} leaving party ${partyId}`);
            remove(ref(db, `parties/${partyId}/members/${uid}`))
                .then(() => {
                    console.log('Successfully left party');
                    get(ref(db, `parties/${partyId}/members`)).then(snapshot => {
                        if (!snapshot.exists()) {
                            remove(ref(db, `parties/${partyId}`))
                                .catch(error => console.error(`Error removing empty party: ${error.message}`));
                        }
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnPartyLeft', 'success');
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    }).catch(error => {
                        console.error(`Error checking party members: ${error.code} - ${error.message}`);
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnPartyLeft', error.message);
                        } else {
                            console.error('Unity instance not initialized');
                        }
                    });
                })
                .catch(error => {
                    console.error(`Error leaving party: ${error.code} - ${error.message}`);
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPartyLeft', error.message);
                    } else {
                        console.error('Unity instance not initialized');
                    }
                });
        };

        window.FirebaseLoadPartyMembers = function (partyId, callbackObjectName) {
            console.log(`Loading party members for party ${partyId}`);
            get(ref(db, `parties/${partyId}/members`)).then(snapshot => {
                let members = [];
                if (snapshot.exists()) {
                    const memberPromises = [];
                    snapshot.forEach(child => {
                        const uid = child.key;
                        const memberData = child.val();
                        const username = memberData.username || 'Unknown';
                        memberPromises.push(
                            get(ref(db, `users/${uid}/online`)).then(onlineSnapshot => ({
                                uid: uid,
                                username: username,
                                online: onlineSnapshot.val() || false
                            }))
                        );
                    });
                    Promise.all(memberPromises)
                        .then(memberData => {
                            members = memberData.map(m => `${m.username}:${m.uid}:${m.online}`);
                            console.log(`Party members loaded: ${members.join('-')}`);
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnPartyMembersLoaded', members.join('-'));
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        })
                        .catch(error => {
                            console.error(`Error fetching online status for party members: ${error.code} - ${error.message}`);
                            if (unityInstance) {
                                unityInstance.SendMessage(callbackObjectName, 'OnPartyMembersLoaded', '');
                            } else {
                                console.error('Unity instance not initialized');
                            }
                        });
                } else {
                    console.log('No party members found');
                    if (unityInstance) {
                        unityInstance.SendMessage(callbackObjectName, 'OnPartyMembersLoaded', '');
                    } else {
                        console.error('Unity instance not initialized');
                    }
                }
            }).catch(error => {
                console.error(`Error loading party members: ${error.code} - ${error.message}`);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnPartyMembersLoaded', '');
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };

        window.FirebaseGetPlayerRank = function (uid, gameMode, callbackObjectName) {
            const field = gameMode === "MoonRan" ? "MoonRanCrowns" : "TeamMoonRanCrowns";
            console.log(`Loading player rank for UID ${uid} in ${gameMode}`);
            get(ref(db, 'users').orderByChild(field)).then((snapshot) => {
                let users = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    const crowns = userData[field] || 0;
                    if (crowns > 0) {
                        users.push({
                            uid: child.key,
                            username: userData.username || 'Unknown',
                            crowns: crowns
                        });
                    }
                });
                users.sort((a, b) => {
                    if (b.crowns !== a.crowns) {
                        return b.crowns - a.crowns;
                    }
                    return a.username.localeCompare(b.username);
                });
                let rank = 0;
                let currentCrowns = -1;
                let sameCrownCount = 0;
                for (let i = 0; i < users.length; i++) {
                    if (users[i].crowns !== currentCrowns) {
                        rank += sameCrownCount + 1;
                        currentCrowns = users[i].crowns;
                        sameCrownCount = 0;
                    } else {
                        sameCrownCount++;
                    }
                    if (users[i].uid === uid) {
                        console.log(`Player ${uid} rank in ${gameMode}: ${rank}`);
                        if (unityInstance) {
                            unityInstance.SendMessage(callbackObjectName, 'OnPlayerRankLoaded', `${gameMode}|${rank}`);
                        } else {
                            console.error('Unity instance not initialized');
                        }
                        return;
                    }
                }
                console.log(`Player ${uid} not ranked in ${gameMode} (0 crowns or not found)`);
                if (unityInstance) {
                    unityInstance.SendMessage(callbackObjectName, 'OnPlayerRankLoaded', `${gameMode}|0`);
                } else {
                    console.error('Unity instance not initialized');
                }
            }).catch((error) => {
                console.error(`Error loading rank for UID ${uid} in ${gameMode}: ${error.code} - ${error.message}`);
                if (unityInstance) {
                    unityInstance.SendMessage('LeaderboardManager', 'OnPlayerRankLoaded', `${gameMode}|0`);
                } else {
                    console.error('Unity instance not initialized');
                }
            });
        };
    </script>
</head>
<body>
    <div id="unity-container">
        <canvas id="unity-canvas"></canvas>
        <div id="loading-overlay">Loading NeouWebGL...</div>
        <button id="fullscreen-button">Fullscreen</button>
    </div>
    <script>
        var unityInstance = null;
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingOverlay = document.querySelector("#loading-overlay");

        document.querySelector("#fullscreen-button").addEventListener("click", () => {
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => console.error("Fullscreen error:", err));
            } else {
                document.exitFullscreen();
            }
        });

        const possibleBuildPaths = [
            "Build/NeouWebGL.loader.js",
            "Build/neouwebgl.loader.js",
            "Build/NeouWebGL/NeouWebGL.loader.js"
        ];

        function tryLoadUnityScript(index = 0) {
            if (index >= possibleBuildPaths.length) {
                console.error("All Unity script load attempts failed.");
                loadingOverlay.innerText = 'Failed to load the game. Please check your network, file paths, or Unity build settings.';
                return;
            }

            const buildScriptPath = possibleBuildPaths[index];
            console.log(`Attempting to load Unity script: ${buildScriptPath}`);

            var script = document.createElement("script");
            script.src = buildScriptPath;
            script.onload = () => {
                console.log(`Unity script loaded successfully: ${buildScriptPath}`);
                const buildName = buildScriptPath.split('/').pop().replace('.loader.js', '');
                createUnityInstance(canvas, {
                    dataUrl: `Build/${buildName}.data`,
                    frameworkUrl: `Build/${buildName}.framework.js`,
                    codeUrl: `Build/${buildName}.wasm`,
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "DefaultCompany",
                    productName: "1.0",
                    productVersion: "1.0",
                    autoSyncPersistentDataPath: true
                }).then((instance) => {
                    unityInstance = instance;
                    loadingOverlay.style.display = 'none';
                    console.log('Unity instance initialized');
                }).catch((error) => {
                    console.error("Unity initialization error:", error.message);
                    loadingOverlay.innerText = 'Failed to initialize the game. Please try again.';
                });
            };
            script.onerror = (error) => {
                console.error(`Failed to load Unity script at ${buildScriptPath}:`, error.message);
                console.error(`Check if the file exists at ${buildScriptPath} and is accessible. Possible issues: file missing, incorrect path, server permissions, or incorrect MIME type.`);
                console.error(`Attempting next path (if available)...`);
                tryLoadUnityScript(index + 1);
            };
            document.body.appendChild(script);
        }

        tryLoadUnityScript();

        document.addEventListener('click', () => {
            if (typeof AudioContext !== 'undefined' && unityInstance && unityInstance.Module.audioContext) {
                unityInstance.Module.audioContext.resume().then(() => console.log('Audio context resumed'));
            }
        }, { once: true });
    </script>
</body>
</html>
